<link rel="stylesheet" href="../style.css">

<body>
</body>

<script type="module">

  import { THREE, ThreeGame } from '../src/ThreeGame.js';

  
  const image = new Image();
  image.src = '../levels/classic/fruit.png';

  await image.decode();

  const canvas = document.createElement( 'canvas' );
  canvas.width = image.width;
  canvas.height = image.height;

  const ctx = canvas.getContext( '2d' );
  ctx.drawImage( image, 0, 0 );

  const pixelBuffer = new Uint32Array(
    ctx.getImageData( 0, 0, canvas.width, canvas.height ).data.buffer
  );

  const blocks = Array.from( pixelBuffer, 
    color => color == 0 ? null : new THREE.Color( color ) 
  );

  const positions = [];
  const colors = [];
  const indices = [];
  
  const cols = image.width, rows = image.height;
  let index = 0;
  for ( let row = 0; row < rows; row ++ ) {
    for ( let col = 0; col < cols; col ++ ) {
      const block = blocks[ col + row * cols ];

      if ( block ) {
        // Top
        [ 0, 1 ].forEach( z => {
          [ 1, 0 ].forEach( x => {
            positions.push( col + x, 0, row + z);
          } );
        });
  
        indices.push( index,     index + 1, index + 2 );
        indices.push( index + 2, index + 1, index + 3 );
        index += 4;

        for ( let i = 0; i < 4; i ++ ) {
          colors.push( block.b, block.g, block.r );   // colors are backwards for some reason
        }
      }
    }
  }

  pixelBuffer.forEach( color => {
    const r = ( color & 0xFF ) / 255;
    const g = ( ( color >> 8 ) & 0xFF ) / 255; 
    const b = ( ( color >> 16 ) & 0xFF ) / 255;

    
  } );
  
  const geometry = new THREE.BufferGeometry();
  geometry.setAttribute( 'position', new THREE.Float32BufferAttribute( positions, 3 ) );
  geometry.setAttribute( 'color', new THREE.Float32BufferAttribute( colors, 3 ) );
  geometry.setIndex( indices );

  const material = new THREE.MeshPhongMaterial( {
    color: 0xffffff,
    flatShading: true,
    vertexColors: true,
    shininess: 0
  } );

  const BLOCK_WIDTH = 0.5, BLOCK_HEIGHT = 0.5, BLOCK_LENGTH = 1;

  
  const scene = new THREE.Scene();
  scene.background = new THREE.Color( 0x111122 );

  const light = new THREE.DirectionalLight( 0xffffff );
  light.position.set( 0, 1, 0.5 );
  light.target.position.set( 0, 0, 0 );
  scene.add( light );
  
  const mesh = new THREE.Mesh( geometry, material );
  mesh.scale.set( BLOCK_WIDTH, BLOCK_HEIGHT, BLOCK_LENGTH );
  scene.add( mesh );


  const game = new ThreeGame();

  game.scene = scene;
  game.camera.position.set( cols * BLOCK_WIDTH / 2, 1, rows * BLOCK_LENGTH + 2 );

  game.update = ( dt ) => {
  }

</script>