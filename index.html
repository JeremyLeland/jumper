<head>
  <title>Jumper v0.9</title>
  <link rel="stylesheet" href="../style.css">
</head>

<body>
  <div class="speed">Speed: <span id="speed"></span></div>
</body>

<script type="module">

  import * as THREE from '../lib/three.module.js';
  import { ThreeGame } from '../src/ThreeGame.js';
  import { Level } from '../src/Level.js';
  import { Player } from '../src/Player.js';

  const LEVEL_COLS = 9;

  const CAMERA_Y = 3;
  const CAMERA_FOLLOW_Z = 4;
  const CAMERA_LOOK_Z = -3;

  const LIGHT_Y = 10;
  const LIGHT_FOLLOW_Z = 5;

  const scene = new THREE.Scene();
  scene.background = new THREE.Color( 0x111122 ); 

  const light = new THREE.DirectionalLight( 0xffffff );

  //
  // TODO: Figure out how this works, tune as needed
  //
  light.castShadow = true;

  // const dLight = 200;
  // const sLight = dLight * 0.25;
  // light.shadow.camera.left = - sLight;
  // light.shadow.camera.right = sLight;
  // light.shadow.camera.top = sLight;
  // light.shadow.camera.bottom = - sLight;

  // light.shadow.camera.near = dLight / 30;
  // light.shadow.camera.far = dLight;

  light.shadow.mapSize.width = 1024 * 2;
  light.shadow.mapSize.height = 1024 * 2;

  // light.shadow.camera.visible = true;

  // scene.add(new THREE.CameraHelper(light.shadow.camera));
  //
  //
  //

  scene.add( light );
  scene.add( light.target );

  const player = new Player();;
  scene.add( player.mesh );
  
  const game = new ThreeGame();
  game.renderer.shadowMap.enabled = true;
  game.scene = scene;

  let level;
  await loadLevel( './levels/classic/03.png' );

  async function loadLevel( src ) {
    if ( level ) {
      scene.remove( level.mesh );
      level.mesh.geometry.dispose();
      level.mesh.material.dispose();
    }
    
    level = await Level.fromImageSrc( src );
  
    scene.add( level.mesh );

    player.spawn( level );

    light.position.x = player.position.x;
    light.position.y = LIGHT_Y;

    game.camera.position.x = player.position.x;
    game.camera.position.y = CAMERA_Y;
  }

  const speedUI = document.getElementById( 'speed' );

  game.start( ( dt ) => {
    player.update( { dt: dt, level: level, keysPressed: game.keysPressed } );
    speedUI.innerText = player.speed;

    light.position.z = player.position.z + LIGHT_FOLLOW_Z;
    light.target.position.set( light.position.x, 0, player.position.z );

    game.camera.position.z = player.position.z + CAMERA_FOLLOW_Z;
    game.camera.lookAt( game.camera.position.x, 0, player.position.z + CAMERA_LOOK_Z );
  } );

  //
  // Drag and drop to load levels
  //
  window.ondragover = ( event ) => {
    event.preventDefault();
  }
  window.ondrop = ( event ) => {
    event.preventDefault();

    if ( event.dataTransfer.items ) {
      for ( let i = 0; i < event.dataTransfer.items.length; i ++ ) {
        if ( event.dataTransfer.items[ i ].kind === 'file' ) {
          const file = event.dataTransfer.items[ i ].getAsFile();
          const reader = new FileReader();
          reader.onloadend = () => {
            loadLevel( reader.result );
          };
          reader.readAsDataURL( file );
        }
      }
    }
    else {
      for ( let i = 0; i < event.dataTransfer.files.length; i ++ ) {
        loadLevel( event.dataTransfer.files[ i ].name );
      }
    }
  }

</script>